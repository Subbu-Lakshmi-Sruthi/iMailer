{% extends "dashboard/main.html" %}
{% load static %}
{% load crispy_forms_tags %}
{% block content %}
<style>
    .no_button{
        background: none;
        border: none;
    }
    .hr-text {
        line-height: 1em;
        position: relative;
        outline: 0;
        border: 0;
        color: black;
        text-align: center;
        height: 1.5em;
        opacity: 0.5;
    }
    .hr-text:before {
        content: "";
        background: linear-gradient(to right, transparent, #818078, transparent);
        position: absolute;
        left: 0;
        top: 50%;
        width: 100%;
        height: 1px;
    }
    .hr-text:after {
        content: attr(data-content);
        position: relative;
        display: inline-block;
        color: black;
        padding: 0 0.5em;
        line-height: 1.5em;
        background-color: #fcfcfa;
    }
</style>
<div class="page-wrapper">
    <div class="content">
        <div class="card-body">
            <ul class="nav nav-tabs nav-tabs-solid nav-tabs-rounded nav-justified">
                <li class="nav-item"><a class="nav-link active" href="#solid-rounded-justified-tab1" data-bs-toggle="tab" style="color: #222;">Select Recipients</a></li>
                <li class="nav-item"><a class="nav-link" href="#solid-rounded-justified-tab2" data-bs-toggle="tab" style="color: #222;" id="compose_btn">Compose</a></li>
                <li class="nav-item"><a class="nav-link" href="#solid-rounded-justified-tab3" data-bs-toggle="tab" style="color: #222;">Use Templates</a></li>
            </ul>
            <div class="tab-content">
                <div class="tab-pane show active" id="solid-rounded-justified-tab1">
                    <div class="container" style="margin-top: 20px;">
                        <p>Import CSV</p>
                        <input type="file" id="fileInput" accept=".csv" onchange="handleFileSelect(event)" class="form-control">
                        <br>
                        <hr class="hr-text" data-content="OR">
                        <p style="text-align: center; position: relative; bottom: 25px;">OR</p>
                        <p>Add Recipient</p>
                        <div class="row">
                            <div class="col-md-3"><label for="recipient_name">Name</label><input type="text" name="recipient_name" id="recipient_name" class="form-control"></div>
                            <div class="col-md-3"><label for="recipient_email">Email</label><input type="email" name="recipient_email" id="recipient_email" class="form-control"></div>
                            <div class="col-md-2"><label for="recipient_age">Age</label><input type="number" name="recipient_age" id="recipient_age" class="form-control"></div>
                            <div class="col-md-2"><label for="recipient_gender">Gender</label><input type="text" name="recipient_gender" id="recipient_gender" class="form-control"></div>
                            <div class="col-md-2"><br><button class="btn btn-primary" onclick="populate_ind_table()">Add</button></div>
                        </div>

                        <hr>
                        <div class="card">
                            <div class="card-body">
                                <p>Recipient List</p>
                                <div class="table-top">
                                    <div class="search-set">
                                        <div class="search-input">
                                            <a class="btn btn-searchset"><img src=" {% static 'assets/img/icons/search-white.svg' %} "
                                                    alt="img"></a>
                                        </div>
                                    </div>
                                    <div class="wordset">
                                        <ul>
                                            <li>
                                                <a data-bs-toggle="tooltip" data-bs-placement="top" title="pdf"><img
                                                        src=" {% static 'assets/img/icons/pdf.svg' %} " alt="img"></a>
                                            </li>
                                            <li>
                                                <a data-bs-toggle="tooltip" data-bs-placement="top" title="excel"><img
                                                        src=" {% static 'assets/img/icons/excel.svg' %} " alt="img"></a>
                                            </li>
                                            <li>
                                                <a data-bs-toggle="tooltip" data-bs-placement="top" title="print"><img
                                                        src=" {% static 'assets/img/icons/printer.svg' %} " alt="img"></a>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                                <div class="table-responsive">
                                    <table class="table datanew" id="tableP">
                                        <thead >
                                            <tr>
                                                <th>Name</th>
                                                <th>Email</th>
                                                <th>Age</th>
                                                <th>Gender</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="output">
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="tab-pane show" id="solid-rounded-justified-tab2">
                    <div class="container" style="margin-top: 20px;">
                        <form method="post" style="width: 75%;" id="mail_form">
                            {% csrf_token %}
                            {{ form.media }}
                            {{ form|crispy }}
                            <textarea name="recipient_list" id="recipient_list" style="display: none;"></textarea>
                            <input type="submit" value="Create" class="btn btn-submit me-2">
                        </form>
                    </div>
                </div>
                <div class="tab-pane" id="solid-rounded-justified-tab3">
                    <div class="container" style="margin-top: 20px;">
                        <div class="card">
                            <div class="card-body">
                                <div class="table-top">
                                    <div class="search-set">
                                        <div class="search-input">
                                            <a class="btn btn-searchset"><img src=" {% static 'assets/img/icons/search-white.svg' %} "
                                                    alt="img"></a>
                                        </div>
                                    </div>
                                    <div class="wordset">
                                        <ul>
                                            <li>
                                                <a data-bs-toggle="tooltip" data-bs-placement="top" title="pdf"><img
                                                        src=" {% static 'assets/img/icons/pdf.svg' %} " alt="img"></a>
                                            </li>
                                            <li>
                                                <a data-bs-toggle="tooltip" data-bs-placement="top" title="excel"><img
                                                        src=" {% static 'assets/img/icons/excel.svg' %} " alt="img"></a>
                                            </li>
                                            <li>
                                                <a data-bs-toggle="tooltip" data-bs-placement="top" title="print"><img
                                                        src=" {% static 'assets/img/icons/printer.svg' %} " alt="img"></a>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                                <div class="modal fade" id="myModal" role="dialog">
                                    <div class="modal-dialog modal-lg">
                                      <div class="modal-content">
                                        <div class="modal-header">
                                          <button type="button" class="close" data-bs-dismiss="modal">&times;</button>
                                          <h4 class="modal-title">Preview</h4>
                                        </div>
                                        <div class="modal-body">
                                          <p id="modal_content"></p>
                                        </div>
                                      </div>
                                    </div>
                                </div>
                                <div class="table-responsive">
                                    <table class="table datanew">
                                        <thead>
                                            <tr>
                                                <th>Template Name</th>
                                                <th>Visibitlity</th>
                                                <th>Created By</th>
                                                <th>Action</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for template in templates %}
                                            <tr>
                                                <td>{{ template.name }}</td>
                                                {% if template.visibility %}
                                                <td>Public</td>
                                                {% else %}
                                                <td>Private</td>
                                                {% endif %}
                                                <td>{{ template.created_by }}</td>
                                                <td>
                                                    <div style="display: none;" id="content_{{template.id}}">
                                                        {{ template.body|safe }}
                                                    </div>
                                                    <a class="me-3" onclick="template_populate('{{ template.id }}')">
                                                        <img src=" {% static 'assets/img/icons/use_this.png' %} " alt="img" style="width: 20px">
                                                    </a>
                                                    <button type="button" class="no_button" data-bs-toggle="modal" data-bs-target="#myModal" onclick="content_populate('{{ template.id }}')"><img src=" {% static 'assets/img/icons/eye1.svg' %} " alt="img"></button>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                            {% for template in public_templates %}
                                            <tr>
                                                <td>{{ template.name }}</td>
                                                {% if template.visibility %}
                                                <td>Public</td>
                                                {% else %}
                                                <td>Private</td>
                                                {% endif %}
                                                <td>{{ template.created_by }}</td>
                                                <td>
                                                    <div style="display: none;" id="content_{{template.id}}">
                                                        {{ template.body|safe }}
                                                    </div>
                                                    <a class="me-3" onclick="template_populate('{{ template.id }}')">
                                                        <img src=" {% static 'assets/img/icons/use_this.png' %} " alt="img" style="width: 20px">
                                                    </a>
                                                    <button type="button" class="no_button" data-bs-toggle="modal" data-bs-target="#myModal" onclick="content_populate('{{ template.id }}')"><img src=" {% static 'assets/img/icons/eye1.svg' %} " alt="img"></button>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="https://cdn.ckeditor.com/ckeditor5/36.0.1/classic/ckeditor.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
<script>
    window.onload = ()=>{
        document.getElementById("mail_form").onsubmit = (e)=>{
            var final_json = {}
            e.preventDefault();
            var t = $("#tableP").DataTable();
            final_json["length"] = t.rows().data().length; 
            var item = {}
            for(var i = 0; i<t.rows().data().length; i++){
                item["name"] = t.rows().data()[i][0];
                item["email"] = t.rows().data()[i][1];
                item["age"] = t.rows().data()[i][2];
                item["gender"] = t.rows().data()[i][3];
                final_json[i] = item
                item = {}
            }
            document.getElementById("recipient_list").value = JSON.stringify(final_json);
            document.getElementById("mail_form").submit();
        }
    }
    function content_populate(id){
        document.getElementById("modal_content").innerHTML = document.getElementById(`content_${id}`).innerHTML;
    }
    function template_populate(id){
        var editor = CKEDITOR.instances['id_content'].setData(document.getElementById(`content_${id}`).innerHTML);
        document.getElementById('compose_btn').click();
    }
    var id = 0;
    function populate_ind_table(){
        var name = document.getElementById("recipient_name");
        var email = document.getElementById("recipient_email");
        var age = document.getElementById("recipient_age");
        var gender = document.getElementById("recipient_gender");
        var arr = [name.value, email.value, age.value, gender.value, `<a class="confirm-text">
                                        <img src=" {% static 'assets/img/icons/delete.svg' %} " alt="img" class="icon-delete">
                                    </a>`];
        var t = $("#tableP").DataTable();
        id += 1;
        var rowNode = t.row.add(arr).draw(false);
        name.value = "";
        email.value = "";
        age.value = "";
        gender.value = "";
    }
    $('#tableP tbody').on( 'click', 'img.icon-delete', function () {
        var t = $("#tableP").DataTable();
        t.row( $(this).parents('tr') )
        .remove()
        .draw();
} );
    function handleFileSelect(event) {
        var file = event.target.files[0];
        var table = document.getElementById("output");
        var t = $("#tableP").DataTable();
        Papa.parse(file, {
            header: true,
            dynamicTyping: true,
            complete: function(results) {
                var headers = Object.keys(results.data[0]);
                results.data.forEach(function(row) {
                    var arr = [];
                    headers.forEach(function(header) {
                        arr.push(row[header]);
                    });
                    arr.push(`<a class="confirm-text">
                                        <img src=" {% static 'assets/img/icons/delete.svg' %} " alt="img" class="icon-delete">
                                    </a>`)
                    if (arr[0] != null){
                        t.row.add(arr).draw(false);
                    }
                });
            }
        });
    }

    const  Spam_word_ls = ['As seen on','Buy','Buy direct','Buying judgments','Clearance','Order','Order status',
    'Orders shipped by shopper','Dig up dirt on friends','Meet singles','Score with babes','XXX','Near you',
    'Additional income','Be your own boss','Compete for your business','Double your','Earn $','Earn extra cash',
    'Earn per week','Expect to earn','Extra income','Home based','Home employment','Homebased business',
    'Income from home','Make $','Make money','Money making','Online biz opportunity','Online degree','Opportunity',
    'Potential earnings','University diplomas','While you sleep','Work at home','Work from home','$$$',
    'Affordable','Bargain','Beneficiary','Best price','Big bucks','Cash','Cash bonus','Cashcashcash',
    'Cents on the dollar','Cheap','Check','Claims','Collect','Compare rates','Cost','Credit','Credit bureaus',
    'Discount','Earn','Easy terms','F r e e','Fast cash','For just $XXX','Hidden assets','hidden charges','Income',
    'Incredible deal','Insurance','Investment','Loans','Lowest price','Million dollars','Money','Money back',
    'Mortgage','Mortgage rates','No cost','No fees','One hundred percent free','Only $','Pennies a day','Price',
    'Profits','Pure profit','Quote','Refinance','Save $','Save big money','Save up to','Serious cash',
    'Subject to credit','They keep your money — no refund!','Unsecured credit','Unsecured debt','US dollars',
    'Why pay more?','Accept credit cards','Cards accepted','Check or money order','Credit card offers',
    'Explode your business','Full refund','Investment decision','No credit check','No hidden Costs','No investment',
    'Requires initial investment','Sent in compliance','Stock alert','Stock disclaimer statement','Stock pick',
    'Avoice bankruptcy','Calling creditors','Collect child support','Consolidate debt and credit','Consolidate your debt',
    'Eliminate bad credit','Eliminate debt','Financially independent','Get out of debt','Get paid','Lower interest rate',
    'Lower monthly payment','Lower your mortgage rate','Lowest insurance rates','Pre-approved','Refinance home',
    'Social security number','Your income','Acceptance','Accordingly','Avoid','Chance','Dormant','Freedom','Here',
    'Hidden','Home','Leave','Lifetime','Lose','Maintained','Medium','Miracle','Never','Passwords','Problem','Remove',
    'Reverses','Sample','Satisfaction','Solution','Stop','Success','Teen','Wife','Dear [email/friend/somebody]','Friend',
    'Hello','Ad','Auto email removal','Bulk email','Click','Click below','Click here','Click to remove','Direct email',
    'Direct marketing','Email harvest','Email marketing','Form','Increase sales','Increase traffic','Increase your sales',
    'Internet market','Internet marketing','Marketing','Marketing solutions','Mass email','Member','Month trial offer',
    'More Internet Traffic','Multi level marketing','Notspam','One time mailing','Online marketing','Open','Opt in',
    'Performance','Removal instructions','Sale','Sales','Search engine listings','Search engines','Subscribe','The following form',
    "This isn't junk","This isn't spam",'Undisclosed recipient','Unsubscribe','Visit our website','We hate spam','Web traffic',
    'Will not believe your eyes','Cures baldness','Diagnostic','Fast Viagra delivery','Human growth hormone','Life insurance',
    'Lose weight','Lose weight spam','Medicine','No medical exams','Online pharmacy','Removes wrinkles','Reverses aging','Stop snoring',
    'Valium','Viagra','Vicodin','Weight loss','Xanax','#1','100% free','100% satisfied','4U','50% off','Billion','Billion dollars',
    'Join millions','Join millions of Americans','Million','One hundred percent guaranteed','Thousands','Being a member',
    'Billing address','Call','Cannot be combined with any other offer','Confidentially on all orders','Deal','Financial freedom',
    'Gift certificate','Giving away','Guarantee','Have you been turned down?','If only it were that easy',
    'Important information regarding','In accordance with laws','Long distance phone offer','Mail in order form','Message contains',
    'Name brand','Nigerian','No age restrictions','No catch','No claim forms','No disappointment','No experience','No gimmick',
    'No inventory','No middleman','No obligation','No purchase necessary','No questions asked','No selling','No strings attached',
    'No-obligation','Not intended','Obligation','Off shore','Offer','Per day','Per week','Priority mail','Prize','Prizes',
    'Produced and sent out','Reserves the right','Shopping spree','Stuff on sale','Terms and conditions','The best rates',
    "They’re just giving it away",'Trial','Unlimited','Unsolicited','Vacation','Vacation offers','Warranty','We honor all',
    'Weekend getaway','What are you waiting for?','Who really wins?','Win','Winner','Winning','Won','You are a winner!',
    'You have been selected','You’re a Winner!','Cancel at any time','Compare','Copy accurately','Get','Give it away',
    'Print form signature','Print out and fax','See for yourself','Sign up free today','Free','Free access','Free cell phone',
    'Free consultation','Free DVD','Free gift','Free grant money','Free hosting','Free installation','Free Instant','Free investment',
    'Free leads','Free membership','Free money','Free offer','Free preview','Free priority mail','Free quote','Free sample','Free trial',
    'Free website','All natural','All new','Amazing','Certified','Congratulations','Drastically reduced','Fantastic deal',
    'For free','Guaranteed','It’s effective','Outstanding values','Promise you','Real thing','Risk free','Satisfaction guaranteed',
    'Access','Act now!','Apply now','Apply online','Call free','Call now',"Can't live without",'Do it today',"Don't delete",
    "Don't hesitate",'For instant access','For Only','For you','Get it now','Get started now','Great offer','Info you requested',
    'Information you requested','Instant','Limited time','New customers only','Now','Now only','Offer expires','Once in lifetime',
    'One time','Only','Order now','Order today','Please read','Special promotion','Supplies are limited','Take action now',
    'Time limited','Urgent','While supplies last','Addresses on CD','Beverage','Bonus','Brand new pager','Cable converter','Casino',
    'Celebrity','Copy DVDs','Laser printer','Legal','Luxury car','New domain extensions','Phone','Rolex','Stainless steel'];

    window.onload = () => {CKEDITOR.instances['id_content'].on('change', function() { 
            ckeditor()
        });
    }

    function ckeditor() {
        for (var instance in CKEDITOR.instances){
            CKEDITOR.instances[instance].updateElement();
        }
        var temp = CKEDITOR.instances[instance].getData();
        const myString = $(temp).text();  
        let words = myString.split(" ")
        console.log(myString);
        for (i of Spam_word_ls){
            for(j of words){
                if (i == j){
                    alert(j +" "+ "is a considered a spam word");

            }
        }
    }

}
</script>
{% endblock %}